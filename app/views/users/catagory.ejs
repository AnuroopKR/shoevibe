<%-include("../layouts/header.ejs")%>
	<!-- Start Banner Area -->
	<section class="banner-area organic-breadcrumb" >
		<div class="container">
			<div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
				<div class="col-first">
					<h1>Shop Category page</h1>
					<nav class="d-flex align-items-center">
						<a href="index.html">Home<span class="lnr lnr-arrow-right"></span></a>
						<a href="#">Shop<span class="lnr lnr-arrow-right"></span></a>
						<a href="category.html">Fashon Category</a>
					</nav>
				</div>
			</div>
		</div>
	</section>
	<!-- End Banner Area -->
	<div class="container">
		<div class="row">
			<div class="col-xl-3 col-lg-4 col-md-5">
				<div class="sidebar-categories">
					<div class="head">Browse Categories</div>
					<ul class="main-categories">
						<%category.forEach(cat=>{%>
						<li class="main-nav-list"><a href="#" onclick="loadProduct('<%=cat._id%>')" ><%=cat.name%><span class="number"></span></a></li>
						<%})%>
					</ul>
				</div>
				<div class="sidebar-filter mt-50">
					
					
					
				</div>
			</div>
			<div class="col-xl-9 col-lg-8 col-md-7">
				<!-- Start Filter Bar -->
				<div class="filter-bar d-flex flex-wrap align-items-center">
					<!-- <div class="sorting">
						<select id="select-type">
							<option value="All">All</option>
							<option value="men">men</option>
							<option value="ladies">ladies</option>
							<option value="kids">kids</option>
						</select>
					</div> -->
					<!-- <div class="sorting mr-auto">
						<select>
							<option value="1">Show 12</option>
							<option value="1">Show 12</option>
							<option value="1">Show 12</option>
						</select>
					</div> -->
					<div class="pagination" id="page-number">
					</div>
				</div>
				<!-- End Filter Bar -->
				<!-- Start Best Seller -->
				<section class="lattest-product-area pb-40 category-list">
					<div id="product-list">

					</div>
					
				</section>
				<!-- End Best Seller -->
				<!-- Start Filter Bar -->
				<div class="filter-bar d-flex flex-wrap align-items-center">
					<div class="sorting mr-auto">
						<!-- <select>
							<option value="1">Show 12</option>
							<option value="1">Show 12</option>
							<option value="1">Show 12</option>
						</select> -->
					</div>
					<!-- <div class="pagination">
						<a href="#" class="prev-arrow"><i class="fa fa-long-arrow-left" aria-hidden="true"></i></a>
						<a href="#" class="active">1</a>
						<a href="#">2</a>
						<a href="#">3</a>
						<a href="#" class="dot-dot"><i class="fa fa-ellipsis-h" aria-hidden="true"></i></a>
						<a href="#">6</a>
						<a href="#" class="next-arrow"><i class="fa fa-long-arrow-right" aria-hidden="true"></i></a>
					</div> -->
				</div>
				<!-- End Filter Bar -->
			</div>
		</div>
	</div>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

	<script>
		// if select the genter
		$(document).ready(function(){
			$('#select-type').change(function(){
				const val=$('#select-type').val();
				const categoryId=$('#category-id').val()
				console.log(val,categoryId);
			})
		})
	</script>
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			loadProduct("null");

		 });


// 		 $(document).ready(function() {
//   $('#page-number').on('click', '.active', function(event) {
//     event.preventDefault();

//     // Get the value (text content) of the clicked <a> tag with class .active
//     var data = $(this).text();
//     console.log('Clicked data:', data);

//     // Get the value of the category ID input
//     const categoryId = $('#category-id').val();
    
//     // Call the loadProduct function with categoryId and data
//     loadProduct(categoryId, data);
//   });
// });


		//  if select page
// 		 $(document).ready(function() {
//   $('#page-number').click(function(event) {
//     event.preventDefault();
// 	const categoryId=$('#category-id').val()
//     var data = $(this).text();
//     console.log('Clicked data:', data);
// 	loadProduct(categoryId,data)
    
//   });
// });

function pagination(pageNum){
	event.preventDefault();
	const categoryId=$('#category-id').val()
	console.log('Clicked data:', pageNum);
	loadProduct(categoryId,pageNum)
}

	 

		 function loadProduct(cat,value) {
			// var value = $('#current-page').text();
			// console.log(value);
    // let status = document.getElementById("statusSelect").value;
    // var category = document.getElementById("category-select").value;
	fetch(`/categoryLoad?id=${cat}&pageNum=${value}`)
	        .then((response) => {
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            return response.json();
        })
        .then(data => {
			console.log(data.pageNum,data.pages);
            const productData = data.productData;
			const wishlist=data.wishlist;
			console.log(productData,data.id);
            const tbody = document.getElementById('product-list');
            let html = `<div id="product-list">`;

            html += `<div class="row">`;
            productData.forEach(product => {
				let offer
				let offerPrice
				if(product.offerId){
					offer=product.offerId.discount
					offerPrice=product.price-(product.price*offer/100)
				}else if(product.category.offerId){
					offer=product.category.offerId.discount 
					offerPrice=product.price-(product.price*offer/100)
				}else{
					offerPrice=product.price
				}
				
				console.log(offer,offerPrice);
                html += `
                <div class="col-lg-4 col-md-6">
                    <div class="single-product">
                        <a href="/userProduct/${product._id}">
                            <img class="img-fluid" src="${product.file[0]}" alt="">
                        </a>
                        <div class="product-details">
                            <h6>${product.productName}</h6>
                            <div class="price">
                                <h6>Rs ${offerPrice}</h6>
                                <h6 class="l-through">Rs ${product.price}</h6>
                            </div>
                            <div class="prd-bottom" id="wish_icon${product._id}">
                                <a href="" class="social-info">
                                    <i class="fa-solid fa-cart-plus fa-2x text-warning"></i>
                                    <p class="hover-text">add to bag</p>
                                </a>`
								if(wishlist){
										if(wishlist.products.includes(product._id)){
											html += `<a href="#" onclick="addWishlist('${product._id}')" class="social-info">
                                    <i class="fab fa-gratipay fa-2x text-primary"></i>
                                    <p class="hover-text">Add Wishlist</p>
                                </a>`
							}else{
									html += `<a href="#" onclick="addWishlist('${product._id}')" class="social-info">
                                    <i class="fab fa-gratipay fa-2x text-warning"></i>
                                    <p class="hover-text">Add Wishlist</p>
								</a>`
								}}else{
									html += `	<a href="#" onclick="addWishlist('${product._id}')" class="social-info">
                                    <i class="fab fa-gratipay fa-2x text-warning"></i>
                                    <p class="hover-text">Add Wishlist</p>
								</a>`
								}
								html +=  `<a href="" class="social-info">
                                    <i class="fas fa-rotate fa-2x text-warning"></i>
                                    <p class="hover-text">compare</p>
                                </a>
                                <a href="" class="social-info">
                                    <i class="fas fa-arrows-up-down-left-right fa-2x text-warning"></i>
                                    <p class="hover-text">view more</p>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            html += `</div>
			<input type="hidden" placeholder="${data.id}" value="${data.id}" id="category-id">`

            html += `</div>`;

            tbody.innerHTML = html; // Insert the generated HTML into the DOM
        
			console.log(data.pageNum,data.pages);
			const page = document.getElementById('page-number');
            let pg = `<div id="page-number">`;

            pg += `
			<a href="#" class="prev-arrow"><i class="fa fa-long-arrow-left" aria-hidden="true"></i></a>`
						for(i=1;i<=data.pages;i++){
							if(!data.pageNum){
								pg +=	`<a href="#" class="active" id="current-page" onclick="pagination(${i})">${i}</a>`

							}
							if(i==data.pageNum){
								pg +=	`<a href="#" class="active" id="current-page" onclick="pagination(${i})">${i}</a>`
							} else{
								pg +=	`<a href="#" id="current-page" onclick="pagination(${i})">${i}</a>`

						}}
						pg +=`<a href="#" class="next-arrow"><i class="fa fa-long-arrow-right" aria-hidden="true"></i></a>`
						page.innerHTML = pg;
		})

        .catch((error) => {
            console.error("There was a problem with the fetch operation:", error);
        });
}


	</script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.2/dist/sweetalert2.min.css">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.2/dist/sweetalert2.min.js"></script>

	<script>
		function addWishlist(id){
			event.preventDefault();
			console.log(id);
			const body={
				id:id
			}
	

			fetch('/addWishlist', {
        method: 'PUT',
		headers: {
            'Content-Type': 'application/json' 
        },
        body: JSON.stringify(body)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json(); 
    })
    .then(data => {
        console.log('Form submitted successfully:', data);
		if(data.error){
			window.location.href = "/login";
		}else{
		if(data.result){
		Swal.fire({
  icon: 'success',
  title: 'Added to Wishlist!',
  text: 'Your item has been added to your wishlist.',
  showConfirmButton: false,
  timer: 2000 
});
		}else{
			Swal.fire({
  icon: 'success',
  title: 'Removed from Wishlist!',
  text: 'Your item has been added to your wishlist.',
  showConfirmButton: false,
  timer: 2000 
});
		}
	
		// $(`#wish_icon${id}`).load(location.href + ` #wish_icon${id}`)
		const categoryId=$('#category-id').val()
		loadProduct(categoryId,null)
		// window.location.reload();  

	   }   
    })
    .catch(error => {
        console.error('There was a problem with the form submission:', error);
        
    });

		}
	</script>

	<!-- <script>
		function category(id){
			fetch('/categoryFilter', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ categoryId:id}) 
        })
        .then(response => { 
            if (response.ok) {
                console.log('Quantity updated successfully');
                // Optionally, you can update the quantity displayed on the page after successful update
            } else {
                console.error('Failed to update quantity');
            }
        })
        .catch(error => console.error('Error updating quantity:', error));
    
		}
	</script> -->

    <%-include("../layouts/footer.ejs")%>